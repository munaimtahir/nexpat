# Mobile App Migration Notes - Registration Number Format Change

## Overview

The backend API has been updated to use a permanent registration number format `mmyy-ct-0000` instead of the previous dynamic format. The mobile app requires updates to align with these changes.

## Required Changes

### 1. Update Generated API Types

The generated types in `src/api/generated/types.ts` need to be regenerated from the backend API schema. The Patient model now includes:

```typescript
export interface Patient {
  registration_number: string;  // Format: mmyy-ct-0000
  name: string;
  phone?: string | null;
  gender: 'MALE' | 'FEMALE' | 'OTHER';
  category: '01' | '02' | '03' | '04' | '05';  // NEW FIELD
  created_at: string;
  updated_at: string;
  last_5_visit_dates?: string[];
}

export interface PatientRequest {
  name: string;
  phone?: string | null;
  gender: 'MALE' | 'FEMALE' | 'OTHER';
  category: '01' | '02' | '03' | '04' | '05';  // NEW FIELD
  // registration_number is auto-generated by backend
}
```

**Category Codes:**
- `01` - Self-paying
- `02` - Insurance
- `03` - Cash
- `04` - Free
- `05` - Poor

### 2. Update PatientFormScreen

Add a category picker to the patient form screen:

```typescript
const categories = [
  { value: '01', label: 'Self-paying' },
  { value: '02', label: 'Insurance' },
  { value: '03', label: 'Cash' },
  { value: '04', label: 'Free' },
  { value: '05', label: 'Poor' },
];
```

### 3. Update Validation

Update any registration number validation to use the new format regex:

```typescript
const REGISTRATION_NUMBER_PATTERN = /^\d{4}-\d{2}-\d{4}$/;
```

### 4. Update API Client

Ensure the generated API client uses the correct endpoint structure:
- Patient lookups use registration number as primary key (e.g., `/api/patients/1025-01-0001/`)
- Patient creation no longer accepts `registration_number` as input (auto-generated)

### 5. Regenerate Types

To regenerate the API types, you'll need to:

1. Ensure the backend is running with the latest migrations applied
2. Use an OpenAPI schema generator or similar tool to extract the API schema
3. Generate TypeScript types from the schema
4. Update `src/api/generated/types.ts` and `src/api/generated/client.ts`

## Testing Checklist

- [ ] Test patient creation with all category options
- [ ] Verify registration number format validation
- [ ] Test patient search and retrieval by registration number
- [ ] Verify patient editing preserves category selection
- [ ] Test offline sync with new patient format
- [ ] Verify API client handles new registration number format in URLs

## Migration for Existing Data

Any existing patient data in the mobile app's local cache will need to be cleared or migrated to the new format. Consider adding a migration script or forcing a cache clear on app update.

## Backend Changes Summary

- Removed `RegistrationNumberFormat` model and dynamic format configuration
- Added `category` field to Patient model (required, default: '01')
- Registration numbers now auto-generated in format `mmyy-ct-0000`
- Serial numbers are unique within each month/category combination
- Old registration format validation removed

## Related Files

- Backend migration: `apps/backend/api/migrations/0011_delete_registrationnumberformat_patient_category.py`
- Backend model: `apps/backend/api/models.py` (Patient model)
- Backend serializer: `apps/backend/api/serializers.py` (PatientSerializer)
- Web form: `apps/web/src/pages/PatientFormPage.jsx`
